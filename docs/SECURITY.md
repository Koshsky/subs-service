# Конфигурация безопасности

Этот документ описывает меры безопасности, реализованные в микросервисной архитектуре subs-service.

## Безопасность gRPC с TLS

### Обзор
Связь между core-service и auth-service использует защищенный gRPC с TLS-шифрованием для предотвращения атак "человек посередине" и обеспечения целостности данных.

### Конфигурация

#### Переменные окружения
- `ENABLE_TLS`: Установите `true` для включения TLS-шифрования (по умолчанию: `true`)
- `TLS_CERT_FILE`: Путь к файлу TLS-сертификата (по умолчанию: `certs/server-cert.pem`)
- `TLS_KEY_FILE`: Путь к файлу приватного ключа TLS (по умолчанию: `certs/server-key.pem`)

#### Настройка для разработки
1. Сгенерируйте самоподписанные сертификаты для разработки:
   ```bash
   ./scripts/generate-certs.sh
   ```

2. Запустите сервисы с включенным TLS (конфигурация по умолчанию)

#### Настройка для продакшена
1. Получите сертификаты от доверенного центра сертификации (CA)
2. Поместите сертификаты в директорию `certs/` или укажите пользовательские пути через переменные окружения
3. Убедитесь в правильных правах доступа к файлам:
   - Файл сертификата: `644` (читается всеми)
   - Файл приватного ключа: `600` (читается только владельцем)

### Реализованные функции безопасности

#### gRPC Сервер (auth-service)
- Использует `credentials.NewServerTLSFromFile()` для загрузки TLS-учетных данных
- Проверяет клиентские соединения с помощью TLS-рукопожатия
- Логирует статус безопасности при запуске

#### gRPC Клиент (core-service)
- Использует `credentials.NewClientTLSFromFile()` для безопасных соединений
- Переходит на небезопасное соединение при сбое настройки TLS (с предупреждением)
- Проверяет сертификат сервера во время соединения

### Безопасность контейнеров
- Оба сервиса работают от имени пользователя без root-прав (`appuser`) с UID 1001
- Минимальные права доступа к файлам приложения
- TLS-сертификаты копируются в контейнеры с правильными правами владения

### Разработка против продакшена

#### Разработка
- Самоподписанные сертификаты допустимы
- Можно отключить TLS, установив `ENABLE_TLS=false` для локального тестирования
- Предупреждающие сообщения указывают на небезопасные соединения

#### Продакшен
- **ОБЯЗАТЕЛЬНО** использовать сертификаты от доверенного CA
- **НИКОГДА** не отключать TLS в продакшн-окружениях
- Мониторить даты истечения сертификатов
- Внедрить процедуры ротации сертификатов

### Устранение неполадок

#### Общие проблемы
1. **Сертификат не найден**: Убедитесь, что файлы сертификатов существуют по указанным путям
2. **Доступ запрещен**: Проверьте права доступа к файлам сертификатов
3. **Соединение отклонено**: Убедитесь, что конфигурации TLS сервера и клиента совпадают
4. **Ошибка проверки сертификата**: Убедитесь, что сертификат действителен и не истек

#### Поведение при сбоях
- Если настройка TLS не удается, клиент выведет предупреждение и попытается небезопасное соединение
- Сервер не сможет запуститься, если TLS включен, но сертификаты недействительны
- Это предотвращает молчаливый переход к небезопасным соединениям в продакшене

### Лучшие практики безопасности
1. Регулярно ротируйте сертификаты (рекомендуется: каждые 90 дней)
2. Используйте сильные алгоритмы шифрования (RSA 4096-бит или ECDSA P-384)
3. Мониторьте истечение сертификатов
4. Никогда не коммитьте приватные ключи в систему контроля версий
5. Используйте правильное хранение сертификатов и контроль доступа в продакшене